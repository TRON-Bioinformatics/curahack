---
title: >
 Studying annotations over time
author: >
  Federico Marini, 
  Maria Stepanyan, 
  Christoph Fritzsch, 
  Patrick Sorn <br>
  The Expressionists :)
output: 
  html_document:
    toc: true 
    toc_float: true
    code_folding: show
    number_sections: true
    theme: cosmo
---

```{r setup, include=FALSE}
# packages required
req_pkgs <- c(
  "GeneTonic",
  "DESeq2",
  "ggplot2",
  "gplots",
  "UpSetR",
  "pcaExplorer",
  "topGO",
  "org.Hs.eg.db"
)

if (!all(req_pkgs %in% installed.packages())) {
  BiocManager::install(req_pkgs)
  BiocManager::install("imbeimainz/mosdef")
}
```


# Reading in of all infos for one file

We will focus on control siRNA_1 as a starter

```{r readingin}
list.files("kallisto_results/", recursive = TRUE)

gene_counts_ctrl1_v86 <- read.csv("kallisto_results/v86/Control_siRNA_1/gene_expr.csv", sep = ";")
tx_counts_ctrl1_v86 <- read.csv("kallisto_results/v86/Control_siRNA_1/abundance.tsv", sep = "\t")

# View(gene_counts_ctrl1_v86)
# View(tx_counts_ctrl1_v86)


all_gene_files <- list.files("kallisto_results", pattern = "gene_expr.csv", 
                             recursive = TRUE, full.names = TRUE)
all_sample1_gene_files <- all_gene_files[grep("Control_siRNA_1", all_gene_files)]
all_sample1_gene_files
all_sample1_gene_files <- all_sample1_gene_files[c(c(11:24), c(1:10))]
all_sample1_gene_files

all_tx_files <-   list.files("kallisto_results", pattern = "abundance.tsv", 
                             recursive = TRUE, full.names = TRUE)
all_sample1_tx_files <- all_tx_files[grep("Control_siRNA_1", all_tx_files)]
all_sample1_tx_files
all_sample1_tx_files <- all_sample1_tx_files[c(c(11:24), c(1:10))]
all_sample1_tx_files
```


## Some quantifications of things over time

```{r quantsovertime}
genes_over_time <- lapply(1:24, function(arg) {
  
  gene_file <- read.csv(all_sample1_gene_files[arg], sep = ";")
  n_genes <- nrow(gene_file)
  
  tx_file <- read.csv(all_sample1_tx_files[arg], sep = "\t")
  n_transcripts <- nrow(tx_file)
  
  gene_ids <- gene_file$gene_id
  gene_names <- gene_file$gene_symbol
  
  tx_ids <- tx_file$target_id
  
  out <- list(
    n_genes = n_genes,
    n_transcripts = n_transcripts,
    gene_ids = gene_ids,
    gene_names = gene_names,
    tx_ids = tx_ids
  )
})

names(genes_over_time) <- (list.files("kallisto_results", recursive = FALSE))[c(c(11:24), c(1:10))]

anns_df <- data.frame(
  version = factor(names(genes_over_time), levels = names(genes_over_time)),
  n_genes = sapply(genes_over_time, function(arg) arg$n_genes),
  n_transcripts = sapply(genes_over_time, function(arg) arg$n_transcripts)
)

anns_df
```

Plotting these things a bit


```{r plotsovertime, fig.width=8}
library("ggplot2")

ggplot(anns_df,
       aes(x = version, y = n_genes)) + 
  coord_cartesian(ylim = c(0, NA)) + 
  geom_point() +
  theme_bw() + 
  ggtitle("Number of genes over time", subtitle = "v86 to v109")

ggplot(anns_df,
       aes(x = version, y = n_genes)) + 
  geom_point() +
  theme_bw() + 
  ggtitle("Number of genes over time", subtitle = "v86 to v109")


ggplot(anns_df,
       aes(x = version, y = n_transcripts)) + 
  coord_cartesian(ylim = c(0, NA)) + 
  geom_point() +
  theme_bw() + 
  ggtitle("Number of transcripts over time", subtitle = "v86 to v109")

ggplot(anns_df,
       aes(x = version, y = n_transcripts)) + 
  geom_point() +
  theme_bw() + 
  ggtitle("Number of transcripts over time", subtitle = "v86 to v109")

```


Working a bit more on the "real content" of the genes included in the annotations

* sampling over the whole period

```{r moresets}
gplots::venn(
  list(
    v86 = genes_over_time$v86$gene_ids,
    v94 = genes_over_time$v94$gene_ids,
    v102 = genes_over_time$v102$gene_ids,
    v109 = genes_over_time$v109$gene_ids
  )
)

gplots::venn(
  list(
    v86 = genes_over_time$v86$gene_names,
    v94 = genes_over_time$v94$gene_names,
    v102 = genes_over_time$v102$gene_names,
    v109 = genes_over_time$v109$gene_names
  )
)
```

* sampling a little bit more close over time

```{r setscloseintime}
gplots::venn(
  list(
    v86 = genes_over_time$v86$gene_ids,
    v87 = genes_over_time$v87$gene_ids,
    v88 = genes_over_time$v88$gene_ids,
    v89 = genes_over_time$v89$gene_ids
  )
)

```


Let's take this a little bit next level, with an Upset plot

```{r upsetsanno, fig.width=10}
UpSetR::upset(
  UpSetR::fromList(
    list(
      v86 = genes_over_time$v86$gene_ids,
      v94 = genes_over_time$v94$gene_ids,
      v102 = genes_over_time$v102$gene_ids,
      v109 = genes_over_time$v109$gene_ids
    )
  )
)



UpSetR::upset(
  UpSetR::fromList(
    list(
      v86 = genes_over_time$v86$gene_ids,
      v88 = genes_over_time$v88$gene_ids,
      v90 = genes_over_time$v90$gene_ids,
      v92 = genes_over_time$v92$gene_ids,
      v94 = genes_over_time$v94$gene_ids,
      v96 = genes_over_time$v96$gene_ids,
      v98 = genes_over_time$v98$gene_ids,
      v100 = genes_over_time$v100$gene_ids,
      v102 = genes_over_time$v102$gene_ids,
      v104 = genes_over_time$v104$gene_ids,
      v106 = genes_over_time$v106$gene_ids,
      v109 = genes_over_time$v109$gene_ids
    )
  ), nintersects = NA, nsets = 12
)
```




# DE over time


DE with oldest version

```{r dev86}
all_samples_v86 <- file.path(
  list.files(path = "kallisto_results/v86", 
             full.names = TRUE), 
  "gene_expr.csv")

file.exists(all_samples_v86)

cm_v86 <- data.frame(
  ctrl_r1 =   read.csv(all_samples_v86[1], sep = ";")$count,
  ctrl_r2 =   read.csv(all_samples_v86[2], sep = ";")$count,
  ctrl_r3 =   read.csv(all_samples_v86[3], sep = ";")$count,
  stat5a_r1 = read.csv(all_samples_v86[4], sep = ";")$count,
  stat5a_r2 = read.csv(all_samples_v86[5], sep = ";")$count,
  stat5a_r3 = read.csv(all_samples_v86[6], sep = ";")$count,
  stat5b_r1 = read.csv(all_samples_v86[7], sep = ";")$count,
  stat5b_r2 = read.csv(all_samples_v86[8], sep = ";")$count,
  stat5b_r3 = read.csv(all_samples_v86[9], sep = ";")$count,
  row.names = read.csv(all_samples_v86[1], sep = ";")$gene_id
)

anno_v86 <- data.frame(
  gene_id = read.csv(all_samples_v86[1], sep = ";")$gene_id,
  gene_name = read.csv(all_samples_v86[1], sep = ";")$gene_symbol,
  row.names = read.csv(all_samples_v86[1], sep = ";")$gene_id
)

head(cm_v86)
dim(cm_v86)
head(anno_v86)

samples_metadata <- data.frame(
  group = c("ctrl", "ctrl", "ctrl", 
            "stat5a", "stat5a", "stat5a", 
            "stat5b", "stat5b", "stat5b"),
  id = list.files(path = "kallisto_results/v86")
)

library("DESeq2")

dds_v86 <- DESeq2::DESeqDataSetFromMatrix(
  countData = as.matrix(cm_v86),
  colData = samples_metadata,
  design = ~group
)

dds_v86

rowData(dds_v86) <- anno_v86

pcaExplorer::pcaplot(vst(dds_v86), intgroup = "group", ellipse = FALSE)

dds_v86 <- DESeq(dds_v86)
resultsNames(dds_v86)

summary(results(dds_v86, name = "group_stat5a_vs_ctrl"), alpha = 0.05)
```


DE with latest version

```{r dev109}
all_samples_v109 <- file.path(
  list.files(path = "kallisto_results/v109", 
             full.names = TRUE), 
  "gene_expr.csv")

file.exists(all_samples_v109)

cm_v109 <- data.frame(
  ctrl_r1 =   read.csv(all_samples_v109[1], sep = ";")$count,
  ctrl_r2 =   read.csv(all_samples_v109[2], sep = ";")$count,
  ctrl_r3 =   read.csv(all_samples_v109[3], sep = ";")$count,
  stat5a_r1 = read.csv(all_samples_v109[4], sep = ";")$count,
  stat5a_r2 = read.csv(all_samples_v109[5], sep = ";")$count,
  stat5a_r3 = read.csv(all_samples_v109[6], sep = ";")$count,
  stat5b_r1 = read.csv(all_samples_v109[7], sep = ";")$count,
  stat5b_r2 = read.csv(all_samples_v109[8], sep = ";")$count,
  stat5b_r3 = read.csv(all_samples_v109[9], sep = ";")$count,
  row.names = read.csv(all_samples_v109[1], sep = ";")$gene_id
)

anno_v109 <- data.frame(
  gene_id = read.csv(all_samples_v109[1], sep = ";")$gene_id,
  gene_name = read.csv(all_samples_v109[1], sep = ";")$gene_symbol,
  row.names = read.csv(all_samples_v109[1], sep = ";")$gene_id
)

dim(cm_v109)
head(cm_v109)
head(anno_v109)

dds_v109 <- DESeq2::DESeqDataSetFromMatrix(
  countData = as.matrix(cm_v109),
  colData = samples_metadata,
  design = ~group
)

dds_v109

rowData(dds_v109) <- anno_v109

pcaExplorer::pcaplot(vst(dds_v109), intgroup = "group", ellipse = FALSE)

dds_v109 <- DESeq(dds_v109)
resultsNames(dds_v109)

summary(results(dds_v109, name = "group_stat5a_vs_ctrl"), alpha = 0.05)
```



```{r comparepca, fig.width=12}

library("patchwork")

pcaExplorer::pcaplot(vst(dds_v86), intgroup = "group", ellipse = FALSE, ntop = 500) |
  pcaExplorer::pcaplot(vst(dds_v109), intgroup = "group", ellipse = FALSE, ntop = 500)

pcaExplorer::pcaplot(vst(dds_v86), intgroup = "group", ellipse = FALSE, ntop = 2000) |
  pcaExplorer::pcaplot(vst(dds_v109), intgroup = "group", ellipse = FALSE, ntop = 2000)

pcaExplorer::pcaplot(vst(dds_v86), intgroup = "group", ellipse = FALSE, ntop = 20000) |
  pcaExplorer::pcaplot(vst(dds_v109), intgroup = "group", ellipse = FALSE, ntop = 20000)

```

```{r resde}
res_v86 <- results(dds_v86, name = "group_stat5a_vs_ctrl")
res_v109 <- results(dds_v109, name = "group_stat5a_vs_ctrl")
```


# What about the functional level?

We will do some enrichment analyses on the sets above


```{r runenrich}
library("mosdef")
library("org.Hs.eg.db")

res_enrich_v86 <- mosdef::run_cluPro(
  dds = dds_v86,
  res_de = res_v86,
  mapping = "org.Hs.eg.db", 
  ont = "BP"
)

DT::datatable(as.data.frame(res_enrich_v86))




res_enrich_v109 <- mosdef::run_cluPro(
  dds = dds_v109,
  res_de = res_v109,
  mapping = "org.Hs.eg.db",
  ont = "BP"
)

DT::datatable(as.data.frame(res_enrich_v109))

```

Using topGO to try and obtain more targeted and focused categories

```{r runtopgo}
library("topGO")

res_topgo_v86 <- mosdef::run_topGO(
  dds = dds_v86,
  res_de = res_v86,
  mapping = "org.Hs.eg.db"
)


res_topgo_v109 <- mosdef::run_topGO(
  dds = dds_v109,
  res_de = res_v109,
  mapping = "org.Hs.eg.db"
)

DT::datatable(as.data.frame(res_topgo_v86))
DT::datatable(as.data.frame(res_topgo_v109))
```



Might be a bit brutal, but let's try

```{r mergedgo}
merged_go_df <- merge(
  as.data.frame(res_topgo_v86),
  as.data.frame(res_topgo_v109), 
  by = "GO.ID"
)

plot(merged_go_df$p.value_elim.x, 
     merged_go_df$p.value_elim.y, 
     log = "xy")
abline(a = 0, b = 1)
```



Building up some GeneTonicList object for easy exploration

```{r exploregenetonic}
library("GeneTonic")

gtl_v86 <- GeneTonicList(
  dds_v86,
  res_v86,
  shake_enrichResult(res_enrich_v86),
  annotation_obj = anno_v86
)

gtl_v109 <- GeneTonicList(
  dds_v109,
  res_v109,
  shake_enrichResult(res_enrich_v109),
  annotation_obj = anno_v109
)
```


A more quanti-quali tative approach would be with a representative heatmap

```{r compareheatmaps}
vst_v86 <- vst(dds_v86)
vst_v109 <- vst(dds_v109)

GeneTonic::gs_heatmap(vst_v86,
                      gtl = gtl_v86,
                      geneset_id = "GO:0031640", 
                      anno_col_info = "group")

GeneTonic::gs_heatmap(vst_v109,
                      gtl = gtl_v109,
                      geneset_id = "GO:0031640", 
                      anno_col_info = "group")

```


# Back to the matrix

We go back to the counts of the individual samples

- subsetting to the "common genes" (assuming that they go 1:1, let's see...)
- plotting the same first sample over the two annotations
- confronting that with the own second biological replicate

```{r backtomat}
common_gene_ids <- intersect(rownames(dds_v86),
                             rownames(dds_v109))

dds_v86_common <- dds_v86[common_gene_ids, ]
dds_v109_common <- dds_v109[common_gene_ids, ]

# and now with a "simple difference"...

hist(counts(dds_v86_common)- counts(dds_v109_common), breaks = 1000)

plot(counts(dds_v86_common[,1], normalized = TRUE),
     counts(dds_v109_common[,1], normalized = TRUE), 
     log = "xy")

# cfr with a biological replicate...
plot(counts(dds_v86_common[,1], normalized = TRUE),
     counts(dds_v86_common[,2], normalized = TRUE), 
     log = "xy")
```

--> hey, there's quite a ONE or TWO puntual differences. Maybe something DID change - or probably, given the simmetry, got exactly swapped?


# Possible next steps

- checking some shortlisted candidates?
- investigating a bit more the functional level
- going a bit more quantitative on the DE results, instead of purely with a threshold?



# Session info {-}

```{r sessioninfo}
sessionInfo()
```




